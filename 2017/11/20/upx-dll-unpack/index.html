<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="author" content="Vancir" />
  <title>UPX 3.07 (Unpacking + DLL + Overlay) 脱壳笔记</title>
  <link rel="shortcut icon" href="/favicon.ico" />
  <link href="/feed/" rel="alternate" title="Vancir" type="application/atom+xml" />
  <link rel="stylesheet" href="/media/css/style.css" />
  <link rel="stylesheet" href="/media/css/highlight.css" />
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script type="text/javascript" src="/media/js/outliner.js"></script>
</head>
<!--  <body> 
-->
<script type="text/javascript">
  function setTimeSpan() {
    var date = new Date();
    timeSpan.innerText = date.format('yyyy-MM-dd hh:mm:ss');
  }

  Date.prototype.format = function (format) {
    var o =
      {
        "M+": this.getMonth() + 1, //month
        "d+": this.getDate(),    //day
        "h+": this.getHours(),   //hour
        "m+": this.getMinutes(), //minute
        "s+": this.getSeconds(), //second
        "q+": Math.floor((this.getMonth() + 3) / 3),  //quarter
        "S": this.getMilliseconds() //millisecond
      }
    if (/(y+)/.test(format))
      format = format.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    for (var k in o)
      if (new RegExp("(" + k + ")").test(format))
        format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
    return format;
  }
</script>

<body onLoad="setInterval(setTimeSpan,1000);">
  <div id="container">
    <div id="main" role="main">
      <header>
        <h1>UPX 3.07 (Unpacking + DLL + Overlay) 脱壳笔记</h1>
      </header>
      <nav id="real_nav">
        <span>
          <a title="home" class="" href="/">home</a>
        </span>
        <span>
          <a title="categories" class="" href="/categories/">categories</a>
        </span>
        <span>
          <a title="tags" class="" href="/tags/">tags</a>
        </span>
        <span>
          <a title="tools" class="" href="/repo/">repo</a>
        </span>
        <span>
          <a title="tools" class="" href="/act/">act</a>
        </span>
        <span>
          <a title="tools" class="" href="/books/">books</a>
        </span>
        <span>
          <a title="tools" class="" href="/musics/">musics</a>
        </span>
        <span>
          <a title="tools" class="" href="/movies/">movies</a>
        </span>
        <span>
          <a title="links" class="" href="/friends/">friends</a>
        </span>
        <span>
          <a title="about" class="" href="/about/">about</a>
        </span>
        <span>
          <a title="feed" class="" href="/feed">subscribe</a>
        </span>
      </nav>
      <article class="content">
        <section class="meta">
<span class="time">
  <time datetime="2017-11-20">2017-11-20</time>
</span>

 | 
<span class="categories">
  categories
  
  <a href="/categories/#crack" title="crack">crack</a>&nbsp;
  
</span>


 | 
<span class="tags">
  tags
  
  <a href="/tags/#unpack" title="unpack">unpack</a>&nbsp;
  
</span>

</section>
<section class="post">
<p>Upx作为入门级的简单压缩壳，脱壳方法其实很简单。这里主要介绍的是使用<code class="highlighter-rouge">ImportREC手动脱壳</code>以及<code class="highlighter-rouge">Dll脱壳</code>。</p>

<h2 id="importrec手动脱壳">ImportREC手动脱壳</h2>

<p>我们常用的ImportREC脱壳是使用的软件自带的<code class="highlighter-rouge">IAT auto search</code>，但是如果我们要手动查找IAT的地址并dump出来，又该怎么操作呢？</p>

<p>首先使用ESP定律，可以很快地跳转到<code class="highlighter-rouge">OEP: 00401110</code>。</p>

<p><img src="http://od7mpc53s.bkt.clouddn.com/upx-dll-unpack-1.png" alt="1.png" /></p>

<p>我们右键点击，选择<code class="highlighter-rouge">查找-&gt;所有模块间的调用</code></p>

<p><img src="http://od7mpc53s.bkt.clouddn.com/upx-dll-unpack-2.png" alt="2.png" /></p>

<p>显示出调用的函数列表，我们双击其中的某个函数(注意这里要双击的应该是程序的函数而不是系统函数)</p>

<p><img src="http://od7mpc53s.bkt.clouddn.com/upx-dll-unpack-3.png" alt="3.png" /></p>

<p>我们来到了函数调用处</p>

<p><img src="http://od7mpc53s.bkt.clouddn.com/upx-dll-unpack-4.png" alt="4.png" /></p>

<p>右键点击<code class="highlighter-rouge">跟随</code>，进入函数</p>

<p><img src="http://od7mpc53s.bkt.clouddn.com/upx-dll-unpack-5.png" alt="5.png" /></p>

<p>然后再右键点击<code class="highlighter-rouge">数据窗口中跟随-&gt;内存地址</code></p>

<p><img src="http://od7mpc53s.bkt.clouddn.com/upx-dll-unpack-6.png" alt="6.png" /></p>

<p>这里因为显示是十六进制值，不方便查看，我们可以在数据窗口点击右键选择<code class="highlighter-rouge">长型-&gt;地址</code>，就可以显示函数名</p>

<p><img src="http://od7mpc53s.bkt.clouddn.com/upx-dll-unpack-7.png" alt="7.png" /></p>

<p>注意我们要向上翻到IAT表的起始位置，可以看到最开始的函数地址是<code class="highlighter-rouge">004050D8</code>的<code class="highlighter-rouge">kernel.AddAtomA</code>, 我们向下找到最后一个函数，也就是<code class="highlighter-rouge">user32.MessageBoxA</code>函数，计算一下整个IAT表的大小。在OD的最下方有显示<code class="highlighter-rouge">块大小：0x7C</code>，所以我们整个IAT块大小就是<code class="highlighter-rouge">0x7C</code></p>

<p><img src="http://od7mpc53s.bkt.clouddn.com/upx-dll-unpack-8.png" alt="8.png" /></p>

<p>打开<code class="highlighter-rouge">ImportREC</code>，选择我们正在调试的这个程序，然后分别输入<code class="highlighter-rouge">OEP：1110, RVA:50D8, SIZE:7C</code>，然后点击<code class="highlighter-rouge">获取输入表</code></p>

<p><img src="http://od7mpc53s.bkt.clouddn.com/upx-dll-unpack-9.png" alt="9.png" /></p>

<p>这里在输入表窗口中右键选择<code class="highlighter-rouge">高级命令-&gt;选择代码块</code>。</p>

<p><img src="http://od7mpc53s.bkt.clouddn.com/upx-dll-unpack-10.png" alt="10.png" /></p>

<p>然后会弹出窗口，选择完整转储，保存为<code class="highlighter-rouge">dump.exe</code>文件</p>

<p><img src="http://od7mpc53s.bkt.clouddn.com/upx-dll-unpack-11.png" alt="11.png" /></p>

<p>dump完成后，选择<code class="highlighter-rouge">转储到文件</code>，这里选择修复我们刚刚dump出的dump.exe，得到一个dump_.exe。这时整个脱壳就完成了</p>

<h2 id="dll脱壳">DLL脱壳</h2>

<p>为什么要谈到上面的ImportREC手动脱壳呢？因为Dll脱壳需要这一步骤。Dll脱壳的最关键的步骤在于<code class="highlighter-rouge">LordPE修改其Dll的标志</code>，用<code class="highlighter-rouge">LordPE</code>打开<code class="highlighter-rouge">UnpackMe.dll</code>，然后在特征值那里点击<code class="highlighter-rouge">...</code>，然后取消勾选<code class="highlighter-rouge">DLL</code>标志，保存后，那么系统就会将该文件视作一个可执行文件。</p>

<p><img src="http://od7mpc53s.bkt.clouddn.com/upx-dll-unpack-12.png" alt="12.png" /></p>

<p>我们将<code class="highlighter-rouge">UnpackMe.dll</code>后缀名改成<code class="highlighter-rouge">UnpackMe.exe</code>，然后用OD载入。</p>

<p><img src="http://od7mpc53s.bkt.clouddn.com/upx-dll-unpack-13.png" alt="13.png" /></p>

<p>一般在入口点，程序都会保存一些信息，这里就很简单，只作了一个cmp。要注意的一点是，这里的jnz跳转直接就跳到了Unpack的末尾，因此我们需要修改寄存器的<code class="highlighter-rouge">z</code>标志来使得跳转失效。同时在unpack的末尾设下一个断点以避免脱壳完直接运行。</p>

<p>Dll脱壳的基本步骤跟exe文件脱壳一样，只是要注意，在脱壳完dump后，要记得用LordPE把<code class="highlighter-rouge">DLL</code>标志恢复过来。</p>

</section>
<section align="right">
<br/>
<span>
	<a  href="/2017/11/16/!EP(EXE-Pack)v1_2/" class="pageNav"  >Previous</a>
	&nbsp;&nbsp;&nbsp;
	<a  href="/2017/11/23/taintdroid-install/" class="pageNav"  >Next</a>
</span>
</section>

<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
            
        url = 'http://www.vancir.com/2017/11/16/!EP(EXE-Pack)v1_2/';
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        url = 'http://www.vancir.com/2017/11/23/taintdroid-install/';
        
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>

      </article>
      <a style="position:fixed;bottom:5px;right:5px;" href="#" title="Back to Top">
        <img src="/assets/btt.png" />
      </a>
    </div>
    <footer>
      <p>
        <small>
          Powered by
          <a href="http://jekyllrb.com" target="_blank">Jekyll</a> @
          <a href="https://github.com/Vancir/vancir.github.io" target="_blank" title="project homepage">github</a> | Copyright 2017 - 2018 by
          <a href="/about/">Vancir</a> |
          <span class="label label-info" id="timeSpan"></span>
        </small>
      </p>
    </footer>
  </div>
</body>

</html>