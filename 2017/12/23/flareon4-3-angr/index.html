<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="author" content="Vancir" />
  <title>使用Angr解决Flareon4题目3</title>
  <link rel="shortcut icon" href="/favicon.ico" />
  <link href="/feed/" rel="alternate" title="Vancir" type="application/atom+xml" />
  <link rel="stylesheet" href="/media/css/style.css" />
  <link rel="stylesheet" href="/media/css/highlight.css" />
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script type="text/javascript" src="/media/js/outliner.js"></script>
</head>
<!--  <body> 
-->
<script type="text/javascript">
  function setTimeSpan() {
    var date = new Date();
    timeSpan.innerText = date.format('yyyy-MM-dd hh:mm:ss');
  }

  Date.prototype.format = function (format) {
    var o =
      {
        "M+": this.getMonth() + 1, //month
        "d+": this.getDate(),    //day
        "h+": this.getHours(),   //hour
        "m+": this.getMinutes(), //minute
        "s+": this.getSeconds(), //second
        "q+": Math.floor((this.getMonth() + 3) / 3),  //quarter
        "S": this.getMilliseconds() //millisecond
      }
    if (/(y+)/.test(format))
      format = format.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    for (var k in o)
      if (new RegExp("(" + k + ")").test(format))
        format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
    return format;
  }
</script>

<body onLoad="setInterval(setTimeSpan,1000);">
  <div id="container">
    <div id="main" role="main">
      <header>
        <h1>使用Angr解决Flareon4题目3</h1>
      </header>
      <nav id="real_nav">
        <span>
          <a title="home" class="" href="/">home</a>
        </span>
        <span>
          <a title="categories" class="" href="/categories/">categories</a>
        </span>
        <span>
          <a title="tags" class="" href="/tags/">tags</a>
        </span>
        <span>
          <a title="tools" class="" href="/repo/">repo</a>
        </span>
        <span>
          <a title="tools" class="" href="/act/">act</a>
        </span>
        <span>
          <a title="tools" class="" href="/books/">books</a>
        </span>
        <span>
          <a title="tools" class="" href="/musics/">musics</a>
        </span>
        <span>
          <a title="tools" class="" href="/movies/">movies</a>
        </span>
        <span>
          <a title="links" class="" href="/friends/">friends</a>
        </span>
        <span>
          <a title="about" class="" href="/about/">about</a>
        </span>
        <span>
          <a title="feed" class="" href="/feed">subscribe</a>
        </span>
      </nav>
      <article class="content">
        <section class="meta">
<span class="time">
  <time datetime="2017-12-23">2017-12-23</time>
</span>

 | 
<span class="categories">
  categories
  
  <a href="/categories/#crack" title="crack">crack</a>&nbsp;
  
  <a href="/categories/#translations" title="translations">translations</a>&nbsp;
  
</span>


 | 
<span class="tags">
  tags
  
  <a href="/tags/#RE" title="RE">RE</a>&nbsp;
  
  <a href="/tags/#flareon" title="flareon">flareon</a>&nbsp;
  
</span>

</section>
<section class="post">
<blockquote>
  <p>本文已发表在看雪论坛, 详情可见: <a href="https://bbs.pediy.com/thread-223512.htm">https://bbs.pediy.com/thread-223512.htm</a></p>
</blockquote>

<p>文章作者: XOR Hex</p>

<p>博客地址: <a href="https://blog.xorhex.com/">https://blog.xorhex.com/</a></p>

<p>原文链接: <a href="https://blog.xorhex.com/flare-on-2017-challenge-3/">Flare-On 2017: Challenge 3</a></p>

<p>翻译前言: 这是解决Flareon4第3题的第3种方法. 文章中使用angr编写python脚本来获得flag, 对比之前我翻译的使用Unicorn框架的文章里的代码, 对于刚接触Angr或Unicorn的朋友会有不少帮助.</p>

<p>文中分析的程序你可以点击此处下载: <a href="http://od7mpc53s.bkt.clouddn.com/greek_to_me.zip">greek_to_me.zip</a>, 解压密码: www.pediy.com</p>

<h2 id="准备">准备</h2>

<p>我们用IDA打开文件并调到入口点, 入口点简单地调用了函数<code class="highlighter-rouge">sub_401008</code></p>

<p><img src="https://blog.xorhex.com/content/images/2017/09/greek_to_me_entry_point.png" alt="entry_point.png" /></p>

<p>我们打开这个函数看看, 向下滚动我们可以看到看起来像成功提示的文本字符串, 接下来的标准流程就是找寻成功的分支.</p>

<p><img src="https://blog.xorhex.com/content/images/2017/09/greek_to_me_success_no_flag.png" alt="success_message.png" /></p>

<p>从字符串往回分析, 我们发现一个在<code class="highlighter-rouge">0x40105E</code>处的比较, <code class="highlighter-rouge">eax</code>跟值<code class="highlighter-rouge">0xFB5E</code>进行比较.</p>

<p><img src="https://blog.xorhex.com/content/images/2017/09/greek_to_me_comparison_check.png" alt="eax_comparison_check.png" /></p>

<p>如果<code class="highlighter-rouge">eax</code>匹配成功, 那么随后程序就会继续执行<em>成功</em>分支. 所以我们该如何满足这个匹配呢?</p>

<p>来看看<code class="highlighter-rouge">sub_4011E6</code>函数内部. 我们看到一堆的<code class="highlighter-rouge">mov</code>,<code class="highlighter-rouge">add</code>,<code class="highlighter-rouge">shl</code>和<code class="highlighter-rouge">shr</code>指令, 这可能是某种形式的混淆. 让我们看看传入进函数的参数:</p>

<pre><code class="language-asm">.text:00401047 mov     eax, offset loc_40107C
.text:0040104C mov     [ebp+var_C], eax
.text:0040104F push    79h
.text:00401051 push    [ebp+var_C]
.text:00401054 call    sub_4011E6
</code></pre>

<p>第1个参数存储在<code class="highlighter-rouge">eax</code>寄存器中而第2个参数这是值<code class="highlighter-rouge">0x79</code>. 注意, <code class="highlighter-rouge">eax</code>包含的是<code class="highlighter-rouge">0x40107C</code>的偏移量而第2个参数<code class="highlighter-rouge">0x79</code>看起来很可能是一个表示长度的参数. 我们细细检查函数<code class="highlighter-rouge">sub_4011E6</code>就能证实这点. 也就是说程序即将修改如下所示的汇编代码片段.</p>

<p><img src="https://blog.xorhex.com/content/images/2017/10/greek_to_me_asm_snippet.png" alt="obfuscated_assembly_code.png" /></p>

<p>并没有变量传入解混淆代码, 所以猜测应该是需要某种形式的用户输入, 所以我们继续看.
来到下一个代码块, 我们看到相同的汇编代码区段<code class="highlighter-rouge">0x40107C</code>在传入函数<code class="highlighter-rouge">sub_4011E6之前</code>由<code class="highlighter-rouge">xor</code>和<code class="highlighter-rouge">add</code>指令进行修改.</p>

<p><img src="https://blog.xorhex.com/content/images/2017/09/greek_to_me_deob_round_one.png" alt="first_deobfuscation_routine.png" /></p>

<p><code class="highlighter-rouge">xor</code>的值存储在<code class="highlighter-rouge">dl</code>, 而<code class="highlighter-rouge">dl</code>总是从<code class="highlighter-rouge">[ebp+buf]</code>赋值而来, 这看上去就可能是我们的用户输入了. 继续向上跟踪我们看到<code class="highlighter-rouge">[eax+buf]</code>则是作为参数传递给函数<code class="highlighter-rouge">sub_401121</code></p>

<p><img src="https://blog.xorhex.com/content/images/2017/09/greek_to_me_follow_buf.png" alt="sub_401121_call.png" /></p>

<p>快速浏览函数<code class="highlighter-rouge">sub_401121</code>, 我们看到<code class="highlighter-rouge">0x4011BC</code>处设置了<code class="highlighter-rouge">[ebp+buf]</code></p>

<p><img src="https://blog.xorhex.com/content/images/2017/09/greek_to_me_buf_recv.png" alt="call_to_recv.png" /></p>

<p>函数的剩余部分则仅仅只是服务器接受输入后的一些操作</p>

<p>总结一下收获:</p>

<ul>
  <li>找到了位于<code class="highlighter-rouge">0x4010FE</code>的成功提示字符串</li>
  <li>比较检查在<code class="highlighter-rouge">0x40105E</code>处
    <ul>
      <li>必须匹配<code class="highlighter-rouge">0xFB5E</code>才能进入成功验证分支</li>
    </ul>
  </li>
  <li>已混淆代码起始于<code class="highlighter-rouge">0x40107C</code></li>
  <li>已混淆代码的长度为<code class="highlighter-rouge">0x79</code></li>
  <li>第2阶段的解混淆函数在<code class="highlighter-rouge">0x401054</code>处被调用</li>
  <li>第1阶段的解混淆操作从<code class="highlighter-rouge">0x401029</code>开始到<code class="highlighter-rouge">0x401045</code></li>
  <li>用户输入发生在<code class="highlighter-rouge">0x401015</code>处的函数调用
    <ul>
      <li>用户输入来自网络</li>
      <li>输入缓冲区的长度是<code class="highlighter-rouge">0x4</code></li>
    </ul>
  </li>
</ul>

<h2 id="解答">解答</h2>

<p>在我们开始写脚本解答之前, 我们需要提取那些混淆过的字节出来.</p>

<p>这里我使用IDAPython脚本来提取字节</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'greek_to_me_buffer.asm'</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">idaapi</span><span class="o">.</span><span class="n">get_many_bytes</span><span class="p">(</span><span class="mh">0x40107C</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">))</span>
</code></pre></div></div>

<p>现在我们可以进入下一步, 写脚本!</p>

<h3 id="用户输入">用户输入</h3>

<p>我们知道从网络接收的长度是4字节, 但是聪明的读者可能已经注意到代码中使用<code class="highlighter-rouge">dl</code>赋值给<code class="highlighter-rouge">buf</code>而非<code class="highlighter-rouge">edx</code>, 也就导致实际值的范围是从<code class="highlighter-rouge">0x0</code>到<code class="highlighter-rouge">0xff</code>(<code class="highlighter-rouge">dl</code>只有1字节大小). 我们脚本的开始部分类似如下:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">buf</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mh">0x100</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Using {0}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
</code></pre></div></div>

<h2 id="暴力穷举">暴力穷举</h2>

<p>接下来我们需要修改提取出的比特使得通过比较检查. 我们需要通过解混淆的两部分.</p>

<h2 id="解混淆第1步">解混淆第1步</h2>

<p>对于第1次的解混淆(<code class="highlighter-rouge">0x401039</code>), 我们可以用python简单写一个”解码器”.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c"># Variable to store the bits written to disk using IDA</span>
    <span class="n">asm</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># Store the output from the first de-obfuscation routine</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c"># Read in bytes written to file from IDA</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'greek_to_me_buffer.asm'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">asm</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="c"># Re-implement loc_401039</span>
    <span class="n">dl</span> <span class="o">=</span> <span class="n">buf</span>
    <span class="k">for</span> <span class="n">byte</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
        <span class="n">bl</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">byte</span><span class="p">)</span>
        <span class="n">bl</span> <span class="o">=</span> <span class="n">bl</span> <span class="o">^</span> <span class="n">dl</span>
        <span class="n">bl</span> <span class="o">=</span> <span class="n">bl</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
        <span class="n">bl</span> <span class="o">=</span> <span class="n">bl</span> <span class="o">+</span> <span class="mh">0x22</span>
        <span class="n">bl</span> <span class="o">=</span> <span class="n">bl</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
        <span class="n">b2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bl</span><span class="p">)</span>
</code></pre></div></div>

<p>要记住第1步解混淆操作应该放在for循环块中.</p>

<h2 id="解混淆第2步">解混淆第2步</h2>

<p>在<code class="highlighter-rouge">Angr</code>的帮助下, 我们可以继续按我们的方式进行第2阶段的解混淆, 虽然有点像作弊, 但谁又想用python或c重写一遍解混淆的代码呢?</p>

<p>在<code class="highlighter-rouge">for</code>循环之前一行声明一个<code class="highlighter-rouge">angr</code>工程实例, 这样它就不会在每次<code class="highlighter-rouge">for</code>循环执行时重新创建一遍.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">p</span> <span class="o">=</span> <span class="n">angr</span><span class="o">.</span><span class="n">Project</span><span class="p">(</span><span class="s">'greek_to_me.exe'</span><span class="p">,</span> <span class="n">load_options</span><span class="o">=</span><span class="p">{</span><span class="s">'auto_load_libs'</span><span class="p">:</span> <span class="bp">False</span><span class="p">})</span>
</code></pre></div></div>

<p>设置Angr模拟执行<code class="highlighter-rouge">sub_4011E6</code>, 不过我们这次需要放到<code class="highlighter-rouge">for</code>循环里去.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c"># Set up angr to "run" sub_4011E6 </span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">blank_state</span><span class="p">(</span><span class="n">addr</span><span class="o">=</span><span class="mh">0x4011E6</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">mem</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">esp</span><span class="o">+</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">dword</span> <span class="o">=</span> <span class="mi">1</span>    <span class="c"># Angr memory location to hold the xor'ed and add'ed bytes</span>
    <span class="n">s</span><span class="o">.</span><span class="n">mem</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">esp</span><span class="o">+</span><span class="mi">8</span><span class="p">:]</span><span class="o">.</span><span class="n">dword</span> <span class="o">=</span> <span class="mh">0x79</span> <span class="c"># Length of ASM</span>

    <span class="c"># Copy bytes output from loc_401039 into address 0x1 so Angr can run it</span>
    <span class="n">asm</span> <span class="o">=</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">b2</span><span class="p">))</span>
    <span class="n">s</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">se</span><span class="o">.</span><span class="n">BVV</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">asm</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'hex'</span><span class="p">),</span> <span class="mi">16</span><span class="p">),</span> <span class="mh">0x79</span> <span class="o">*</span> <span class="mi">8</span> <span class="p">))</span>

    <span class="c"># Create a simulation manager...</span>
    <span class="n">simgr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">simulation_manager</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="c"># Tell Angr where to go, though there is only one way through this function, </span>
    <span class="c"># we just need to stop after ax is set</span>
    <span class="n">simgr</span><span class="o">.</span><span class="n">explore</span><span class="p">(</span><span class="n">find</span><span class="o">=</span><span class="mh">0x401268</span><span class="p">)</span>
</code></pre></div></div>

<p>虽然我意识到在这里使用Angr可能有点过犹不及, 但它是我手上最新的工具, 所以我所有的问题都以Angr的方式来解决.</p>

<h2 id="输入合法性检查">输入合法性检查</h2>

<p>接下来我们需要检查<code class="highlighter-rouge">ax</code>的输出是否匹配<code class="highlighter-rouge">0xFB5E</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c"># Once ax is set, check to see if the value in ax matches the comparison value</span>
    <span class="k">for</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">simgr</span><span class="o">.</span><span class="n">found</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">found</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="nb">eval</span><span class="p">(</span><span class="n">found</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">ax</span><span class="p">)))</span>
        <span class="c"># Comparison check</span>
        <span class="k">if</span> <span class="nb">hex</span><span class="p">(</span><span class="n">found</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="nb">eval</span><span class="p">(</span><span class="n">found</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">ax</span><span class="p">))</span> <span class="o">==</span> <span class="s">'0xfb5eL'</span><span class="p">:</span>
            <span class="c"># Will cover what to do here in the next section</span>
            <span class="k">pass</span>
</code></pre></div></div>

<h2 id="解混淆代码">解混淆代码</h2>

<p>现在我们已经满足了校验值匹配, 我们将解混淆的代码输出到屏幕上</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>�e�]��E�t�_�U��E�t�E�u�U��E�b�E�r�E�u�E�t�]߈U��E�f�E�o�E�r�E�c�]��E�@�E�f�E�l�E�a�E�r�]��E�-�E�o�E�n�E�.�E�c�E�o�E�m�E�
</code></pre></div></div>

<p>我们猜测这应该是汇编代码. 我们使用<code class="highlighter-rouge">Capstone</code>反编译代码.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">capstone</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">md</span> <span class="o">=</span> <span class="n">Cs</span><span class="p">(</span><span class="n">CS_ARCH_X86</span><span class="p">,</span> <span class="n">CS_MODE_32</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">md</span><span class="o">.</span><span class="n">disasm</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"0x</span><span class="si">%</span><span class="s">x</span><span class="se">\t</span><span class="si">%</span><span class="s">s</span><span class="se">\t</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">mnemonic</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">op_str</span><span class="p">))</span>
</code></pre></div></div>

<p>再次运行脚本, 我们可以确定这是汇编代码并且填充入缓冲区的内容里出现了ASCII字符.</p>

<pre><code class="language-asm">0x1000	mov	bl, 0x65	None
0x1002	mov	byte ptr [ebp - 0x2b], bl
0x1005	mov	byte ptr [ebp - 0x2a], 0x74
0x1009	mov	dl, 0x5f	None
0x100b	mov	byte ptr [ebp - 0x29], dl
0x100e	mov	byte ptr [ebp - 0x28], 0x74
0x1012	mov	byte ptr [ebp - 0x27], 0x75
0x1016	mov	byte ptr [ebp - 0x26], dl
0x1019	mov	byte ptr [ebp - 0x25], 0x62
0x101d	mov	byte ptr [ebp - 0x24], 0x72
0x1021	mov	byte ptr [ebp - 0x23], 0x75
0x1025	mov	byte ptr [ebp - 0x22], 0x74
0x1029	mov	byte ptr [ebp - 0x21], bl
0x102c	mov	byte ptr [ebp - 0x20], dl
0x102f	mov	byte ptr [ebp - 0x1f], 0x66
0x1033	mov	byte ptr [ebp - 0x1e], 0x6f
0x1037	mov	byte ptr [ebp - 0x1d], 0x72
0x103b	mov	byte ptr [ebp - 0x1c], 0x63
0x103f	mov	byte ptr [ebp - 0x1b], bl
0x1042	mov	byte ptr [ebp - 0x1a], 0x40
0x1046	mov	byte ptr [ebp - 0x19], 0x66
0x104a	mov	byte ptr [ebp - 0x18], 0x6c
0x104e	mov	byte ptr [ebp - 0x17], 0x61
0x1052	mov	byte ptr [ebp - 0x16], 0x72
0x1056	mov	byte ptr [ebp - 0x15], bl
0x1059	mov	byte ptr [ebp - 0x14], 0x2d
0x105d	mov	byte ptr [ebp - 0x13], 0x6f
0x1061	mov	byte ptr [ebp - 0x12], 0x6e
0x1065	mov	byte ptr [ebp - 0x11], 0x2e
0x1069	mov	byte ptr [ebp - 0x10], 0x63
0x106d	mov	byte ptr [ebp - 0xf], 0x6f
0x1071	mov	byte ptr [ebp - 0xe], 0x6d
0x1075	mov	byte ptr [ebp - 0xd], 0	
</code></pre>
<h2 id="嵌入的ascii字符">嵌入的ASCII字符</h2>

<p>既然我们能够手动将上面汇编中可显字符的十六进制转换成字符, 我们为什么不用脚本来完成这一工作呢. 修改<code class="highlighter-rouge">for</code>循环:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bl</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">dl</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">flag</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c"># Using capstone, interpret the ASM</span>
<span class="kn">from</span> <span class="nn">capstone</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">md</span> <span class="o">=</span> <span class="n">Cs</span><span class="p">(</span><span class="n">CS_ARCH_X86</span><span class="p">,</span> <span class="n">CS_MODE_32</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">md</span><span class="o">.</span><span class="n">disasm</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">):</span>
    <span class="n">flag_char</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># The if statements do the work of interpreting the ASCII codes to their value counterpart</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">op_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">','</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">"byte ptr"</span><span class="p">):</span>
        <span class="n">flag_char</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">long</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">op_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">','</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">op_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">','</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'bl'</span><span class="p">):</span>
        <span class="n">bl</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">long</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">op_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">','</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">op_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">','</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'dl'</span><span class="p">):</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">long</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">op_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">','</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">op_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">','</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">'dl'</span><span class="p">:</span>
        <span class="n">flag_char</span> <span class="o">=</span> <span class="n">dl</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">op_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">','</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">'bl'</span><span class="p">:</span>
        <span class="n">flag_char</span> <span class="o">=</span> <span class="n">bl</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">flag_char</span><span class="p">):</span>
        <span class="n">flag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag_char</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"0x</span><span class="si">%</span><span class="s">x</span><span class="se">\t</span><span class="si">%</span><span class="s">s</span><span class="se">\t</span><span class="si">%</span><span class="s">s</span><span class="se">\t</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">mnemonic</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">op_str</span><span class="p">,</span> <span class="n">flag_char</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
</code></pre></div></div>

<p>最后运行脚本得到flag</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>et_tu_brute_force@flare-on.com
</code></pre></div></div>

<h2 id="结论">结论</h2>

<p>总体上我们解决题目用的静态方法十分有趣, 同时也让我有机会首次在CTF竞赛中使用<code class="highlighter-rouge">Angr</code>和<code class="highlighter-rouge">Capstone</code>. 一开始我使用的是<code class="highlighter-rouge">Angr 6</code>来解决该问题, 但后来因为在CTF的中途<code class="highlighter-rouge">Angr</code>更新新版本, 所以写脚本的时候用的是<code class="highlighter-rouge">Angr 7</code>. 如果我随后使用了<code class="highlighter-rouge">Unicorn</code>引擎和<code class="highlighter-rouge">Angr</code>再次解决的话我会回来更新这篇文章.</p>

<p>完整的脚本代码你可以在这里找到: <a href="https://bitbucket.org/snippets/XOR_Hex/kByG75">greek_to_me_angr7.py</a></p>

</section>
<section align="right">
<br/>
<span>
	<a  href="/2017/12/22/flareon4-3-libpeconv/" class="pageNav"  >Previous</a>
	&nbsp;&nbsp;&nbsp;
	<a  href="/2017/12/24/flareon4-3-winappdbg/" class="pageNav"  >Next</a>
</span>
</section>

<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
            
        url = 'http://localhost:4000/2017/12/22/flareon4-3-libpeconv/';
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        url = 'http://localhost:4000/2017/12/24/flareon4-3-winappdbg/';
        
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>

      </article>
      <a style="position:fixed;bottom:5px;right:5px;" href="#" title="Back to Top">
        <img src="/assets/btt.png" />
      </a>
    </div>
    <footer>
      <p>
        <small>
          Powered by
          <a href="http://jekyllrb.com" target="_blank">Jekyll</a> @
          <a href="https://github.com/Vancir/vancir.github.io" target="_blank" title="project homepage">github</a> | Copyright 2017 - 2018 by
          <a href="/about/">Vancir</a> |
          <span class="label label-info" id="timeSpan"></span>
        </small>
      </p>
    </footer>
  </div>
</body>

</html>