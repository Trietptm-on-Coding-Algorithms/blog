<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="author" content="Vancir" />
  <title>Base64自定义字符集的一道逆向</title>
  <link rel="shortcut icon" href="/favicon.ico" />
  <link href="/feed/" rel="alternate" title="Vancir" type="application/atom+xml" />
  <link rel="stylesheet" href="/media/css/style.css" />
  <link rel="stylesheet" href="/media/css/highlight.css" />
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script type="text/javascript" src="/media/js/outliner.js"></script>
</head>
<!--  <body> 
-->
<script type="text/javascript">
  function setTimeSpan() {
    var date = new Date();
    timeSpan.innerText = date.format('yyyy-MM-dd hh:mm:ss');
  }

  Date.prototype.format = function (format) {
    var o =
      {
        "M+": this.getMonth() + 1, //month
        "d+": this.getDate(),    //day
        "h+": this.getHours(),   //hour
        "m+": this.getMinutes(), //minute
        "s+": this.getSeconds(), //second
        "q+": Math.floor((this.getMonth() + 3) / 3),  //quarter
        "S": this.getMilliseconds() //millisecond
      }
    if (/(y+)/.test(format))
      format = format.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    for (var k in o)
      if (new RegExp("(" + k + ")").test(format))
        format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
    return format;
  }
</script>

<body onLoad="setInterval(setTimeSpan,1000);">
  <div id="container">
    <div id="main" role="main">
      <header>
        <h1>Base64自定义字符集的一道逆向</h1>
      </header>
      <nav id="real_nav">
        <span>
          <a title="home" class="" href="/">home</a>
        </span>
        <span>
          <a title="categories" class="" href="/categories/">categories</a>
        </span>
        <span>
          <a title="tags" class="" href="/tags/">tags</a>
        </span>
        <span>
          <a title="tools" class="" href="/repo/">repo</a>
        </span>
        <span>
          <a title="tools" class="" href="/act/">act</a>
        </span>
        <span>
          <a title="tools" class="" href="/books/">books</a>
        </span>
        <span>
          <a title="tools" class="" href="/musics/">musics</a>
        </span>
        <span>
          <a title="tools" class="" href="/movies/">movies</a>
        </span>
        <span>
          <a title="links" class="" href="/friends/">friends</a>
        </span>
        <span>
          <a title="about" class="" href="/about/">about</a>
        </span>
        <span>
          <a title="feed" class="" href="/feed">subscribe</a>
        </span>
      </nav>
      <article class="content">
        <section class="meta">
<span class="time">
  <time datetime="2017-10-23">2017-10-23</time>
</span>

 | 
<span class="categories">
  categories
  
  <a href="/categories/#writeups" title="writeups">writeups</a>&nbsp;
  
</span>


 | 
<span class="tags">
  tags
  
  <a href="/tags/#CTF" title="CTF">CTF</a>&nbsp;
  
</span>

</section>
<section class="post">
<p>这次分析的是<code class="highlighter-rouge">WhiteHat Grand Prix Qualification Round 2015</code>的一道100分的逆向题<code class="highlighter-rouge">Dong Van</code>. 这道题的关键在于使用了<code class="highlighter-rouge">自定义编码</code>的<code class="highlighter-rouge">Base64</code>来处理字符串.</p>

<p>文件下载地址: <a href="http://od7mpc53s.bkt.clouddn.com/re100_35d14595b17756b79556f6eca775c31a">re100_35d14595b17756b79556f6eca775c31a</a></p>

<h2 id="分析">分析</h2>

<p>下载下来是7z压缩文件, 用7z解压. 使用file命令查看文件属性, 是一个x64的ELF可执行文件</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  dong-van chmod +x Re100
➜  dong-van file Re100
Re100: ELF 64-bit LSB executable, x86-64, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, <span class="k">for </span>GNU/Linux 2.6.24, BuildID[sha1]<span class="o">=</span>6c7c0504ab2f342427f59846298e97f9e4fbb98f, not stripped
</code></pre></div></div>

<p>使用<code class="highlighter-rouge">IDA Pro(64 bits)</code>打开文件, <code class="highlighter-rouge">shift+f12</code>查找文件中出现的字符串, 我们发现了一些比较关键的信息</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.rodata:00000000004036F8	00000041	C	ELF8n0BKxOCbj/WU9mwle4cG6hytqD+P3kZ7AzYsag2NufopRSIVQHMXJri51Tdv
.rodata:0000000000403741	00000014	C	Input your secret: 
.rodata:0000000000403755	00000019	C	<span class="nv">ms4otszPhcr7tMmzGMkHyFn</span><span class="o">=</span>
.rodata:000000000040376E	0000001E	C	Good boy! Submit your flag :<span class="o">)</span>
.rodata:000000000040378C	0000000B	C	Too bad :<span class="o">(</span>
</code></pre></div></div>

<p>那么我们就可以猜测程序的执行逻辑是这样的</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>输入secret -&gt; 处理secret -&gt; 将处理过的secret与正确但已被处理过的secret进行比较 -&gt; 根据比较结果输出提示信息.
</code></pre></div></div>
<p>而且显然<code class="highlighter-rouge">ms4otszPhcr7tMmzGMkHyFn=</code>是一个base64字符串.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ <span class="nb">echo</span> <span class="nt">-n</span> <span class="nv">ms4otszPhcr7tMmzGMkHyFn</span><span class="o">=</span> | base64 <span class="nt">--decode</span> 
��<span class="o">(</span>��υ���ɳ��Y%                                    
</code></pre></div></div>
<p>明显解密失败. 但是这是一个base64串基本是可以确认的. 所以这个base64的处理过程有变化.也有可能是先将字符串进行AES加密或其他的加密方式, 然后再进行base64编码.</p>

<p>我们通过交叉引用继续找到主程序继续分析</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// bl
</span>  <span class="kt">char</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// [rsp+0h] [rbp-40h]
</span>  <span class="kt">char</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// [rsp+10h] [rbp-30h]
</span>  <span class="kt">char</span> <span class="n">v7</span><span class="p">;</span> <span class="c1">// [rsp+20h] [rbp-20h]
</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">string</span><span class="p">((</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v5</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">operator</span><span class="o">&lt;&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">,</span> <span class="s">"Input your secret: "</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">operator</span><span class="o">&gt;&gt;&lt;</span><span class="kt">char</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v5</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">string</span><span class="p">((</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v6</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v5</span><span class="p">);</span>
  <span class="n">change</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v6</span><span class="p">);</span>
  <span class="n">v3</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">operator</span><span class="o">==&lt;</span><span class="kt">char</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v7</span><span class="p">,</span> <span class="s">"ms4otszPhcr7tMmzGMkHyFn="</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::~</span><span class="n">string</span><span class="p">((</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v7</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::~</span><span class="n">string</span><span class="p">((</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v6</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="p">)</span>
    <span class="n">std</span><span class="o">::</span><span class="n">operator</span><span class="o">&lt;&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">,</span> <span class="s">"Good boy! Submit your flag :)"</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="n">std</span><span class="o">::</span><span class="n">operator</span><span class="o">&lt;&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">,</span> <span class="s">"Too bad :("</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::~</span><span class="n">string</span><span class="p">((</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v5</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>从反编译代码可以看出, <code class="highlighter-rouge">ms4otszPhcr7tMmzGMkHyFn=</code>是正确但是被处理过的secret, 处理字符串的逻辑主要在于<code class="highlighter-rouge">change(&amp;v7, &amp;v6);</code>这一处. 而且我们点进去观察这个函数, 我们会发现</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>std::string::string(&amp;v19, "ELF8n0BKxOCbj/WU9mwle4cG6hytqD+P3kZ7AzYsag2NufopRSIVQHMXJri51Tdv", &amp;v38);
</code></pre></div></div>

<p>而<code class="highlighter-rouge">ELF8n0BKxOCbj/WU9mwle4cG6hytqD+P3kZ7AzYsag2NufopRSIVQHMXJri51Tdv</code>刚好有64位. 因此可以推测出这是一个自定义编码的base64处理.</p>

<p>因此我们设定自定义编码进行解码, 得到secret.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜ echo ms4otszPhcr7tMmzGMkHyFn= | tr 'ELF8n0BKxOCbj/WU9mwle4cG6hytqD+P3kZ7AzYsag2NufopRSIVQHMXJri51Tdv' 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/' | base64 --decode
Funny_encode_huh!
</code></pre></div></div>

</section>
<section align="right">
<br/>
<span>
	<a  href="/2017/09/20/regular-expression/" class="pageNav"  >Previous</a>
	&nbsp;&nbsp;&nbsp;
	<a  href="/2017/11/15/hctf-level1/" class="pageNav"  >Next</a>
</span>
</section>

<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
            
        url = 'http://localhost:4000/2017/09/20/regular-expression/';
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        url = 'http://localhost:4000/2017/11/15/hctf-level1/';
        
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>

      </article>
      <a style="position:fixed;bottom:5px;right:5px;" href="#" title="Back to Top">
        <img src="/assets/btt.png" />
      </a>
    </div>
    <footer>
      <p>
        <small>
          Powered by
          <a href="http://jekyllrb.com" target="_blank">Jekyll</a> @
          <a href="https://github.com/Vancir/vancir.github.io" target="_blank" title="project homepage">github</a> | Copyright 2017 - 2018 by
          <a href="/about/">Vancir</a> |
          <span class="label label-info" id="timeSpan"></span>
        </small>
      </p>
    </footer>
  </div>
</body>

</html>